const { Telegraf, Markup } = require("telegraf");

const BOT_TOKEN = process.env.BOT_TOKEN;
const PAYMENT_URL = process.env.PAYMENT_URL || "https://example.com/pay";
const ADMIN_CHAT_ID = Number(process.env.ADMIN_CHAT_ID || 0);

if (!BOT_TOKEN) throw new Error("BOT_TOKEN is missing");

const bot = new Telegraf(BOT_TOKEN);

// ====== Memory (Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ) ======
const userLang = {};       // userId -> "ua" | "ru"
const leadState = {};      // userId -> { step, data:{} }
let SEATS_LEFT = 10; // Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¼ÐµÑÑ‚ Ð¿Ð¾ Ð°ÐºÑ†Ð¸Ð¸ (Ð¼ÐµÐ½ÑÐµÑˆÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ)

const TXT = {
  ru: {
    pickLang: "ðŸŒ ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¼Ð¾Ð²Ñƒ / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº:",
    welcome:
      "ðŸ‘‹ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² SalonFlow!\n\n" +
      "Telegram-CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ð¾Ð² ÐºÑ€Ð°ÑÐ¾Ñ‚Ñ‹ ðŸ‡ºðŸ‡¦\n\n" +
      "Ð’Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ:\n" +
      "â€” Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ\n" +
      "â€” ÑÐ¾ÐºÑ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹\n" +
      "â€” Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ\n" +
      "â€” Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ\n\n" +
      "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ðŸ‘‡",
    demo:
      "ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:\n\n" +
      "1ï¸âƒ£ ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ ÑƒÑÐ»ÑƒÐ³Ñƒ\n" +
      "2ï¸âƒ£ Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¼Ð°ÑÑ‚ÐµÑ€Ð°\n" +
      "3ï¸âƒ£ Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð²Ñ€ÐµÐ¼Ñ\n" +
      "4ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ\n" +
      "5ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð·Ð° 24 Ñ‡Ð°ÑÐ°\n" +
      "6ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð·Ð° 2 Ñ‡Ð°ÑÐ°",
    prices:
      "ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹ SalonFlow:\n\n" +
      "Starter â€” 1100 Ð³Ñ€Ð½/Ð¼ÐµÑ\n" +
      "Pro â€” 1700 Ð³Ñ€Ð½/Ð¼ÐµÑ\n" +
      "Salon â€” 3500 Ð³Ñ€Ð½/Ð¼ÐµÑ\n\n" +
      "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð° 24 Ñ‡Ð°ÑÐ°.",
    faq:
      "â“ Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹:\n\n" +
      "â€” Ð’ÑÑ‘ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Telegram\n" +
      "â€” Ð•ÑÑ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ\n" +
      "â€” ÐžÐ½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ\n" +
      "â€” ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð° 24 Ñ‡Ð°ÑÐ°",
    pay: "ðŸ’³ ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ:\n\n",
    leadStart: "ðŸš€ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑÐ°Ð»Ð¾Ð½Ð°\n\n1/4) Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð³Ð¾Ñ€Ð¾Ð´:",
    q2: "2/4) Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð°ÑÑ‚ÐµÑ€Ð¾Ð² Ð² ÑÐ°Ð»Ð¾Ð½Ðµ?",
    q3: "3/4) ÐÑƒÐ¶Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°? (Ð´Ð°/Ð½ÐµÑ‚)",
    q4: "4/4) ÐÑƒÐ¶Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° Â«ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð°?Â» (Ð´Ð°/Ð½ÐµÑ‚)",
    thanks: "âœ… Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð—Ð°ÑÐ²ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°. ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.",
  },
  ua: {
    pickLang: "ðŸŒ ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¼Ð¾Ð²Ñƒ / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº:",
    welcome:
      "ðŸ‘‹ Ð›Ð°ÑÐºÐ°Ð²Ð¾ Ð¿Ñ€Ð¾ÑÐ¸Ð¼Ð¾ Ð´Ð¾ SalonFlow!\n\n" +
      "Telegram-CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ñ–Ð² ÐºÑ€Ð°ÑÐ¸ ðŸ‡ºðŸ‡¦\n\n" +
      "Ð’Ð¸ Ð·Ð¼Ð¾Ð¶ÐµÑ‚Ðµ:\n" +
      "â€” Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ð·Ð°Ð¿Ð¸Ñ\n" +
      "â€” Ð·Ð¼ÐµÐ½ÑˆÐ¸Ñ‚Ð¸ ÑÐºÐ°ÑÑƒÐ²Ð°Ð½Ð½Ñ\n" +
      "â€” Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ\n" +
      "â€” Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÐ²Ð°Ñ‚Ð¸ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ\n\n" +
      "ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð´Ñ–ÑŽ ðŸ‘‡",
    demo:
      "ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð°Ð¿Ð¸ÑÑƒ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°:\n\n" +
      "1ï¸âƒ£ ÐšÐ»Ñ–Ñ”Ð½Ñ‚ Ð¾Ð±Ð¸Ñ€Ð°Ñ” Ð¿Ð¾ÑÐ»ÑƒÐ³Ñƒ\n" +
      "2ï¸âƒ£ ÐžÐ±Ð¸Ñ€Ð°Ñ” Ð¼Ð°Ð¹ÑÑ‚Ñ€Ð°\n" +
      "3ï¸âƒ£ ÐžÐ±Ð¸Ñ€Ð°Ñ” Ñ‡Ð°Ñ\n" +
      "4ï¸âƒ£ ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ\n" +
      "5ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ñ€Ð´ÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð° 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸\n" +
      "6ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ñ€Ð´ÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð° 2 Ð³Ð¾Ð´Ð¸Ð½Ð¸",
    prices:
      "ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ð¸ SalonFlow:\n\n" +
      "Starter â€” 1100 Ð³Ñ€Ð½/Ð¼Ñ–Ñ\n" +
      "Pro â€” 1700 Ð³Ñ€Ð½/Ð¼Ñ–Ñ\n" +
      "Salon â€” 3500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ\n\n" +
      "ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð·Ð° 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸.",
    faq:
      "â“ Ð§Ð°ÑÑ‚Ñ– Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ:\n\n" +
      "â€” Ð’ÑÐµ Ð¿Ñ€Ð°Ñ†ÑŽÑ” Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ– Telegram\n" +
      "â€” Ð„ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ\n" +
      "â€” ÐžÐ½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ”Ñ‚ÑŒÑÑ\n" +
      "â€” ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð·Ð° 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸",
    pay: "ðŸ’³ ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ:\n\n",
    leadStart: "ðŸš€ ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÑÐ°Ð»Ð¾Ð½Ñƒ\n\n1/4) Ð’ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð¼Ñ–ÑÑ‚Ð¾:",
    q2: "2/4) Ð¡ÐºÑ–Ð»ÑŒÐºÐ¸ Ð¼Ð°Ð¹ÑÑ‚Ñ€Ñ–Ð² Ñƒ ÑÐ°Ð»Ð¾Ð½Ñ–?",
    q3: "3/4) ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°? (Ñ‚Ð°Ðº/Ð½Ñ–)",
    q4: "4/4) ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° Â«ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð°?Â» (Ñ‚Ð°Ðº/Ð½Ñ–)",
    thanks: "âœ… Ð”ÑÐºÑƒÑŽ! Ð—Ð°ÑÐ²ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾. ÐœÐ¸ Ð·Ð²â€™ÑÐ¶ÐµÐ¼Ð¾ÑÑŒ Ð· Ð²Ð°Ð¼Ð¸ Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ð¸Ð¼ Ñ‡Ð°ÑÐ¾Ð¼.",
  },
};

function menuKb(lang) {
  if (lang === "ua") {
    return Markup.keyboard([
      ["ðŸŽ¬ Ð”ÐµÐ¼Ð¾-Ð·Ð°Ð¿Ð¸Ñ (60 ÑÐµÐº)"],
      ["ðŸ”¥ ÐŸÐ¾Ð´Ð¸Ð²Ð¸Ñ‚Ð¸ÑÑŒ ÑÐº Ð¿Ñ€Ð°Ñ†ÑŽÑ”", "ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ð¸"],
      ["ðŸš€ ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ ÑÐ°Ð»Ð¾Ð½", "â“ ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ"],
      ["ðŸ’³ ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð° (Ð´ÐµÐ¼Ð¾)"],
    ]).resize();
  }
  return Markup.keyboard([
    ["ðŸŽ¬ Ð”ÐµÐ¼Ð¾-Ð·Ð°Ð¿Ð¸ÑÑŒ (60 ÑÐµÐº)"],
    ["ðŸ”¥ ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", "ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹"],
    ["ðŸš€ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð»Ð¾Ð½", "â“ Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹"],
    ["ðŸ’³ ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð° (Ð´ÐµÐ¼Ð¾)"],
  ]).resize();
}

function getLang(ctx) {
  return userLang[ctx.from.id] || "ru";
}

function sendLanguagePicker(ctx) {
  return ctx.reply(TXT.ru.pickLang, Markup.keyboard([["ðŸ‡ºðŸ‡¦ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°", "ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹"]]).resize());
}

function sendMainMenu(ctx) {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].welcome, menuKb(lang));
}

// ====== Commands ======
bot.command("id", (ctx) => ctx.reply(`Ð’Ð°Ñˆ chat_id: ${ctx.chat.id}`));

bot.start((ctx) => sendLanguagePicker(ctx));

bot.hears("ðŸ‡ºðŸ‡¦ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°", (ctx) => {
  userLang[ctx.from.id] = "ua";
  return sendMainMenu(ctx);
});

bot.hears("ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹", (ctx) => {
  userLang[ctx.from.id] = "ru";
  return sendMainMenu(ctx);
});

// ====== Menu buttons (robust Ð»Ð¾Ð²Ð»Ñ) ======
bot.hears(/Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÐºÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚|Ð¿Ð¾Ð´Ð¸Ð²Ð¸Ñ‚Ð¸ÑÑŒ ÑÐº Ð¿Ñ€Ð°Ñ†ÑŽÑ”/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].demo);
});

bot.hears(/Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹|Ñ‚Ð°Ñ€Ð¸Ñ„Ð¸/i, async (ctx) => {
  const lang = getLang(ctx);

  const text = lang === "ua"
    ? `ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ð¸ SalonFlow

ðŸ”¥ Ð¡Ð¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ð° Ñ†Ñ–Ð½Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÑˆÐ¸Ñ… 10 ÑÐ°Ð»Ð¾Ð½Ñ–Ð²
â³ Ð—Ð°Ð»Ð¸ÑˆÐ¸Ð»Ð¾ÑÑŒ Ð¼Ñ–ÑÑ†ÑŒ: ${SEATS_LEFT}

Starter â€” 1100 Ð³Ñ€Ð½/Ð¼Ñ–Ñ
Pro â€” 1700 Ð³Ñ€Ð½/Ð¼Ñ–Ñ
Salon â€” 3500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ

Ð©Ð¾ Ð²Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ:

âœ” ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ñ–Ð´ ÐºÐ»ÑŽÑ‡
âœ” ÐžÐºÑ€ÐµÐ¼Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´Ð»Ñ Ð²Ð°ÑˆÐ¾Ð³Ð¾ ÑÐ°Ð»Ð¾Ð½Ñƒ
âœ” ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ 24Ñ‡ / 2Ñ‡
âœ” ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°
âœ” ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð±ÐµÐ· Ð´Ð¾Ð¿Ð»Ð°Ñ‚

ðŸ‘‡ ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ñ‡Ðµ, Ñ‰Ð¾Ð± Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ ÑÐ°Ð»Ð¾Ð½:`
    : `ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹ SalonFlow

ðŸ”¥ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ñ†ÐµÐ½Ð° Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ñ‹Ñ… 10 ÑÐ°Ð»Ð¾Ð½Ð¾Ð²
â³ ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¼ÐµÑÑ‚: ${SEATS_LEFT}

Starter â€” 1100 Ð³Ñ€Ð½/Ð¼ÐµÑ
Pro â€” 1700 Ð³Ñ€Ð½/Ð¼ÐµÑ
Salon â€” 3500 Ð³Ñ€Ð½/Ð¼ÐµÑ

Ð§Ñ‚Ð¾ Ð²Ñ…Ð¾Ð´Ð¸Ñ‚:

âœ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ð´ ÐºÐ»ÑŽÑ‡
âœ” ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ ÑÐ°Ð»Ð¾Ð½Ð°
âœ” ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ 24Ñ‡ / 2Ñ‡
âœ” ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
âœ” ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ð´Ð¾Ð¿Ð»Ð°Ñ‚

ðŸ‘‡ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð»Ð¾Ð½:`;

  await ctx.reply(text, {
    reply_markup: {
      keyboard: [
        [{ text: lang === "ua" ? "ðŸš€ ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ ÑÐ°Ð»Ð¾Ð½" : "ðŸš€ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð»Ð¾Ð½" }],
        [{ text: "â¬…ï¸ ÐÐ°Ð·Ð°Ð´" }]
      ],
      resize_keyboard: true
    }
  });
});



bot.hears(/Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹|Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].faq);
});

bot.hears(/Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð° \(Ð´ÐµÐ¼Ð¾\)/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].pay + PAYMENT_URL);
});

// ====== Lead flow start (robust) ======
function startLead(ctx) {
  const uid = ctx.from.id;
  leadState[uid] = { step: 1, data: {} };
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].leadStart, Markup.removeKeyboard());
}

// Ð›Ð¾Ð²Ð¸Ð¼ Ð¸ RU Ð¸ UA, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‡ÑƒÑ‚ÑŒ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ñ‚ÐµÐºÑÑ‚/ÑÐ¼Ð¾Ð´Ð·Ð¸
bot.hears(/Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð»Ð¾Ð½|Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ ÑÐ°Ð»Ð¾Ð½/i, startLead);
// ====== Back to language ======
bot.hears(/Ð½Ð°Ð·Ð°Ð´|â¬…ï¸ Ð½Ð°Ð·Ð°Ð´/i, (ctx) => {
  const uid = ctx.from.id;

  // Ð¡Ð±Ñ€Ð¾Ñ Ð·Ð°ÑÐ²ÐºÐ¸ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð±Ñ‹Ð» Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð»Ð¸Ð´-Ñ„Ð»Ð¾Ñƒ
  if (leadState[uid]) {
    delete leadState[uid];
  }

  // Ð¡Ð±Ñ€Ð¾Ñ ÑÐ·Ñ‹ÐºÐ° (Ð¿Ð¾ Ð¶ÐµÐ»Ð°Ð½Ð¸ÑŽ Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ)
  delete userLang[uid];

  return sendLanguagePicker(ctx);
});

// ====== Lead answers ======
bot.on("text", async (ctx) => {
  const uid = ctx.from.id;
  const st = leadState[uid];
  if (!st) return; // Ð½Ðµ Ð² Ð·Ð°ÑÐ²ÐºÐµ

  const lang = getLang(ctx);
  const text = String(ctx.message.text || "").trim();
  if (!text) return;

  if (st.step === 1) {
    st.data.city = text;
    st.step = 2;
    return ctx.reply(TXT[lang].q2);
  }

  if (st.step === 2) {
    st.data.masters = text;
    st.step = 3;
    return ctx.reply(TXT[lang].q3);
  }

  if (st.step === 3) {
    st.data.prepay = text;
    st.step = 4;
    return ctx.reply(TXT[lang].q4);
  }

  if (st.step === 4) {
    st.data.onlinePayBtn = text;

    const from = ctx.from;
    const adminMsg =
      "ðŸ§¾ ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° SalonFlow\n\n" +
      `ðŸ‘¤ ${from.first_name || ""} ${from.last_name || ""}\n` +
      `ðŸ†” user_id: ${from.id}\n` +
      (from.username ? `ðŸ”— @${from.username}\n` : "") +
      `ðŸ“ Ð“Ð¾Ñ€Ð¾Ð´: ${st.data.city}\n` +
      `ðŸ‘¥ ÐœÐ°ÑÑ‚ÐµÑ€Ð¾Ð²: ${st.data.masters}\n` +
      `ðŸ’° ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°: ${st.data.prepay}\n` +
      `ðŸ’³ ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹: ${st.data.onlinePayBtn}\n`;

    if (ADMIN_CHAT_ID) {
      await ctx.telegram.sendMessage(ADMIN_CHAT_ID, adminMsg);
    }

    delete leadState[uid];
if (SEATS_LEFT > 0) SEATS_LEFT -= 1;

    await ctx.reply(TXT[lang].thanks);
    return sendMainMenu(ctx);
  }
});

bot.launch();
console.log("Sales bot started");
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
