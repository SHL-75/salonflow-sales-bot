const { Telegraf, Markup } = require("telegraf");

const BOT_TOKEN = process.env.BOT_TOKEN;
const PAYMENT_URL = process.env.PAYMENT_URL || "https://example.com/pay";
const ADMIN_CHAT_ID = Number(process.env.ADMIN_CHAT_ID || 0);

if (!BOT_TOKEN) throw new Error("BOT_TOKEN is missing");

const bot = new Telegraf(BOT_TOKEN);

// ====== Memory (Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ) ======
const userLang = {}; // userId -> "ua" | "ru"
const leadState = {}; // userId -> { step, data:{} }
let SEATS_LEFT = 10; // Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¼ÐµÑÑ‚ Ð¿Ð¾ Ð°ÐºÑ†Ð¸Ð¸ (Ð¼ÐµÐ½ÑÐµÑˆÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ)

// ====== Texts ======
const TXT = {
  ru: {
    pickLang: "ðŸŒ ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¼Ð¾Ð²Ñƒ / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº:",
    welcome:
      "ðŸ‘‹ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² SalonFlow!\n\n" +
      "Telegram-CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ð¾Ð² ÐºÑ€Ð°ÑÐ¾Ñ‚Ñ‹ ðŸ‡ºðŸ‡¦\n\n" +
      "Ð§Ñ‚Ð¾ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ:\n" +
      "â€” Ð·Ð°Ð¿Ð¸ÑÑŒ 24/7 Ð±ÐµÐ· Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°\n" +
      "â€” Ð¼ÐµÐ½ÑŒÑˆÐµ Ð¾Ñ‚Ð¼ÐµÐ½ Ð¸ Â«Ð½Ðµ Ð¿Ñ€Ð¸ÑˆÑ‘Ð»Â»\n" +
      "â€” Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼\n" +
      "â€” Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð² CRM-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ\n\n" +
      "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ðŸ‘‡",
    demo:
      "ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:\n\n" +
      "1ï¸âƒ£ ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ ÑƒÑÐ»ÑƒÐ³Ñƒ\n" +
      "2ï¸âƒ£ Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¼Ð°ÑÑ‚ÐµÑ€Ð°\n" +
      "3ï¸âƒ£ Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð²Ñ€ÐµÐ¼Ñ\n" +
      "4ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ\n" +
      "5ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð·Ð° 24 Ñ‡Ð°ÑÐ°\n" +
      "6ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð·Ð° 2 Ñ‡Ð°ÑÐ°",
    // ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ð¿Ñ€Ð¾Ð´Ð°ÑŽÑ‰Ð¸Ð¹ Ð±Ð»Ð¾Ðº (ÐºÐ½Ð¾Ð¿ÐºÐ° Â«ðŸ“ˆ â€¦Â»)
    growth:
      "ðŸ“ˆ ÐšÐ°Ðº SalonFlow ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ¸:\n\n" +
      "âœ… Ð·Ð°Ð¿Ð¸ÑÑŒ 24/7 (ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ, Ð¿Ð¾ÐºÐ° Ð²Ñ‹ Ð·Ð°Ð½ÑÑ‚Ñ‹)\n" +
      "âœ… Ð¼ÐµÐ½ÑŒÑˆÐµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ¾Ð² Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ñ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸ÑÐ¼\n" +
      "âœ… Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°ÑÐ²Ð¾Ðº (Ð²ÑÑ‘ Ð² Ð¾Ð´Ð½Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ)\n\n" +
      "ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ Ð¾ÐºÑƒÐ¿Ð°ÐµÑ‚ÑÑ Ñ 1â€“2 Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ð¼ÐµÑÑÑ†.",
    // ROI (Ð±ÐµÐ· Ð²Ð²Ð¾Ð´Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑƒÑÐ»Ð¾Ð¶Ð½ÑÑ‚ÑŒ Ñ‚ÐµÑÑ‚)
    roi:
      "ðŸ’° Ð Ð°ÑÑ‡Ñ‘Ñ‚ Ð¾ÐºÑƒÐ¿Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸ (Ð±Ñ‹ÑÑ‚Ñ€Ð¾):\n\n" +
      "ÐžÐ´Ð¸Ð½ Â«Ð½Ðµ Ð¿Ñ€Ð¸ÑˆÑ‘Ð»Â» = Ð¼Ð¸Ð½ÑƒÑ ~800â€“1500 Ð³Ñ€Ð½.\n" +
      "1â€“2 ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð¼ÐµÑÑÑ† = ÑÐµÑ€Ð²Ð¸Ñ ÑƒÐ¶Ðµ Ð¾ÐºÑƒÐ¿Ð¸Ð»ÑÑ.\n\n" +
      "ÐŸÑ€Ð¸Ð¼ÐµÑ€:\n" +
      "â€¢ 2 Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ° Ã— 1000 Ð³Ñ€Ð½ = 2000 Ð³Ñ€Ð½ Ð¿Ð¾Ñ‚ÐµÑ€ÑŒ\n" +
      "â€¢ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÑŽÑ‚ ÑÑ‚Ð¸ Ð´ÐµÐ½ÑŒÐ³Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾\n\n" +
      "Ð¥Ð¾Ñ‡ÐµÑˆÑŒ â€” Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼ Ð¸ Ð¿Ð¾ÐºÐ°Ð¶ÐµÐ¼ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð½Ð° Ð²Ð°ÑˆÐµÐ¼ ÑÐ°Ð»Ð¾Ð½Ðµ.",
    pricesShort:
      "ðŸ“Š Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹ SalonFlow:\n\n" +
      "Starter â€” 1500 Ð³Ñ€Ð½/Ð¼ÐµÑ\n" +
      "Pro â€” 2500 Ð³Ñ€Ð½/Ð¼ÐµÑ\n" +
      "Salon â€” 4500 Ð³Ñ€Ð½/Ð¼ÐµÑ",
    faq:
      "â“ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° / Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹:\n\n" +
      "â€” Ð’ÑÑ‘ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Telegram\n" +
      "â€” Ð•ÑÑ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ 24Ñ‡ / 2Ñ‡\n" +
      "â€” ÐžÐ½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ\n" +
      "â€” ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð·Ð° 24 Ñ‡Ð°ÑÐ°\n\n" +
      "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Â«ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ CRMÂ», Ð¸ Ð¼Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼ ÑÐ°Ð»Ð¾Ð½.",
    pay: "ðŸ’³ ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ:\n\n",
    leadStart: "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ð°\n\n1/4) Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð³Ð¾Ñ€Ð¾Ð´:",
    q2: "2/4) Ð¡ÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð°ÑÑ‚ÐµÑ€Ð¾Ð² Ð² ÑÐ°Ð»Ð¾Ð½Ðµ?",
    q3: "3/4) ÐÑƒÐ¶Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°? (Ð´Ð°/Ð½ÐµÑ‚)",
    q4: "4/4) ÐÑƒÐ¶Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° Â«ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð°?Â» (Ð´Ð°/Ð½ÐµÑ‚)",
    thanks: "âœ… Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð—Ð°ÑÐ²ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°. ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.",
    back: "â¬…ï¸ ÐÐ°Ð·Ð°Ð´",
    changeLang: "ðŸŒ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ·Ñ‹Ðº",
  },
  ua: {
    pickLang: "ðŸŒ ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¼Ð¾Ð²Ñƒ / Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº:",
    welcome:
      "ðŸ‘‹ Ð›Ð°ÑÐºÐ°Ð²Ð¾ Ð¿Ñ€Ð¾ÑÐ¸Ð¼Ð¾ Ð´Ð¾ SalonFlow!\n\n" +
      "Telegram-CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ñ–Ð² ÐºÑ€Ð°ÑÐ¸ ðŸ‡ºðŸ‡¦\n\n" +
      "Ð©Ð¾ Ð²Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ”Ñ‚Ðµ:\n" +
      "â€” Ð·Ð°Ð¿Ð¸Ñ 24/7 Ð±ÐµÐ· Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°\n" +
      "â€” Ð¼ÐµÐ½ÑˆÐµ ÑÐºÐ°ÑÑƒÐ²Ð°Ð½ÑŒ Ñ– Â«Ð½Ðµ Ð¿Ñ€Ð¸Ð¹ÑˆÐ¾Ð²Â»\n" +
      "â€” Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°Ð¼\n" +
      "â€” Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ñƒ CRM-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ–\n\n" +
      "ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð´Ñ–ÑŽ ðŸ‘‡",
    demo:
      "ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð°Ð¿Ð¸ÑÑƒ ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð°:\n\n" +
      "1ï¸âƒ£ ÐšÐ»Ñ–Ñ”Ð½Ñ‚ Ð¾Ð±Ð¸Ñ€Ð°Ñ” Ð¿Ð¾ÑÐ»ÑƒÐ³Ñƒ\n" +
      "2ï¸âƒ£ ÐžÐ±Ð¸Ñ€Ð°Ñ” Ð¼Ð°Ð¹ÑÑ‚Ñ€Ð°\n" +
      "3ï¸âƒ£ ÐžÐ±Ð¸Ñ€Ð°Ñ” Ñ‡Ð°Ñ\n" +
      "4ï¸âƒ£ ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ\n" +
      "5ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð° 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸\n" +
      "6ï¸âƒ£ ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð° 2 Ð³Ð¾Ð´Ð¸Ð½Ð¸",
    growth:
      "ðŸ“ˆ Ð¯Ðº SalonFlow Ð·Ð±Ñ–Ð»ÑŒÑˆÑƒÑ” Ð·Ð°Ð¿Ð¸ÑÐ¸:\n\n" +
      "âœ… Ð·Ð°Ð¿Ð¸Ñ 24/7 (ÐºÐ»Ñ–Ñ”Ð½Ñ‚Ð¸ Ð·Ð°Ð¿Ð¸ÑÑƒÑŽÑ‚ÑŒÑÑ, Ð¿Ð¾ÐºÐ¸ Ð²Ð¸ Ð·Ð°Ð¹Ð½ÑÑ‚Ñ–)\n" +
      "âœ… Ð¼ÐµÐ½ÑˆÐµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÑ–Ð² Ð·Ð°Ð²Ð´ÑÐºÐ¸ Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½ÑÐ¼\n" +
      "âœ… ÑˆÐ²Ð¸Ð´ÑˆÐµ Ð¾Ð±Ñ€Ð¾Ð±ÐºÐ° Ð·Ð°ÑÐ²Ð¾Ðº (Ð²ÑÐµ Ð² Ð¾Ð´Ð½Ð¾Ð¼Ñƒ Ð¼Ñ–ÑÑ†Ñ–)\n\n" +
      "Ð—Ð°Ð·Ð²Ð¸Ñ‡Ð°Ð¹ Ð¾ÐºÑƒÐ¿Ð°Ñ”Ñ‚ÑŒÑÑ Ð· 1â€“2 Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ð¸Ñ… Ð·Ð°Ð¿Ð¸ÑÑ–Ð² Ð½Ð° Ð¼Ñ–ÑÑÑ†ÑŒ.",
    roi:
      "ðŸ’° Ð Ð¾Ð·Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº Ð¾ÐºÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ– (ÑˆÐ²Ð¸Ð´ÐºÐ¾):\n\n" +
      "ÐžÐ´Ð¸Ð½ Â«Ð½Ðµ Ð¿Ñ€Ð¸Ð¹ÑˆÐ¾Ð²Â» = Ð¼Ñ–Ð½ÑƒÑ ~800â€“1500 Ð³Ñ€Ð½.\n" +
      "1â€“2 Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ñ– Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð½Ð° Ð¼Ñ–ÑÑÑ†ÑŒ = ÑÐµÑ€Ð²Ñ–Ñ Ð²Ð¶Ðµ Ð¾ÐºÑƒÐ¿Ð¸Ð²ÑÑ.\n\n" +
      "ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´:\n" +
      "â€¢ 2 Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ¸ Ã— 1000 Ð³Ñ€Ð½ = 2000 Ð³Ñ€Ð½ Ð²Ñ‚Ñ€Ð°Ñ‚\n" +
      "â€¢ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ð¾Ð²ÐµÑ€Ñ‚Ð°ÑŽÑ‚ÑŒ Ñ†Ñ– Ð³Ñ€Ð¾ÑˆÑ– Ð½Ð°Ð·Ð°Ð´\n\n" +
      "Ð¥Ð¾Ñ‡ÐµÑ‚Ðµ â€” Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼Ð¾ Ñ– Ð¿Ð¾ÐºÐ°Ð¶ÐµÐ¼Ð¾ Ñ†Ð¸Ñ„Ñ€Ð¸ Ð½Ð° Ð²Ð°ÑˆÐ¾Ð¼Ñƒ ÑÐ°Ð»Ð¾Ð½Ñ–.",
    pricesShort:
      "ðŸ“Š Ð¢Ð°Ñ€Ð¸Ñ„Ð¸ SalonFlow:\n\n" +
      "Starter â€” 1500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ\n" +
      "Pro â€” 2500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ\n" +
      "Salon â€” 4500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ",
    faq:
      "â“ ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° / ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ:\n\n" +
      "â€” Ð’ÑÐµ Ð¿Ñ€Ð°Ñ†ÑŽÑ” Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ– Telegram\n" +
      "â€” Ð„ Ð°Ð²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ 24Ð³ / 2Ð³\n" +
      "â€” ÐžÐ½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ”Ñ‚ÑŒÑÑ\n" +
      "â€” ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð·Ð° 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸\n\n" +
      "ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ Â«ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ CRMÂ», Ñ– Ð¼Ð¸ Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼Ð¾ ÑÐ°Ð»Ð¾Ð½.",
    pay: "ðŸ’³ ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ:\n\n",
    leadStart: "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº CRM Ð´Ð»Ñ ÑÐ°Ð»Ð¾Ð½Ñƒ\n\n1/4) Ð’ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ Ð¼Ñ–ÑÑ‚Ð¾:",
    q2: "2/4) Ð¡ÐºÑ–Ð»ÑŒÐºÐ¸ Ð¼Ð°Ð¹ÑÑ‚Ñ€Ñ–Ð² Ñƒ ÑÐ°Ð»Ð¾Ð½Ñ–?",
    q3: "3/4) ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°? (Ñ‚Ð°Ðº/Ð½Ñ–)",
    q4: "4/4) ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ° Â«ÐžÐ½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð°?Â» (Ñ‚Ð°Ðº/Ð½Ñ–)",
    thanks: "âœ… Ð”ÑÐºÑƒÑŽ! Ð—Ð°ÑÐ²ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾. ÐœÐ¸ Ð·Ð²â€™ÑÐ¶ÐµÐ¼Ð¾ÑÑŒ Ð· Ð²Ð°Ð¼Ð¸ Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ð¸Ð¼ Ñ‡Ð°ÑÐ¾Ð¼.",
    back: "â¬…ï¸ ÐÐ°Ð·Ð°Ð´",
    changeLang: "ðŸŒ Ð—Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ð¼Ð¾Ð²Ñƒ",
  },
};

// ====== Keyboards ======
function menuKb(lang) {
  if (lang === "ua") {
    return Markup.keyboard([
      ["ðŸ“ˆ Ð—Ð±Ñ–Ð»ÑŒÑˆÐ¸Ñ‚Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸"],
      ["ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð° 60 ÑÐµÐºÑƒÐ½Ð´"],
      ["ðŸ’° Ð Ð¾Ð·Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº Ð¾ÐºÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ–"],
      ["ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ CRM"],
      ["ðŸ“Š Ð¢Ð°Ñ€Ð¸Ñ„Ð¸", "â“ ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°"],
      ["ðŸŒ Ð—Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ð¼Ð¾Ð²Ñƒ"],
    ]).resize();
  }
  return Markup.keyboard([
    ["ðŸ“ˆ Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸"],
    ["ðŸŽ¬ Ð”ÐµÐ¼Ð¾ Ð·Ð° 60 ÑÐµÐºÑƒÐ½Ð´"],
    ["ðŸ’° Ð Ð°ÑÑ‡Ñ‘Ñ‚ Ð¾ÐºÑƒÐ¿Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸"],
    ["ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ CRM"],
    ["ðŸ“Š Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹", "â“ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°"],
    ["ðŸŒ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ·Ñ‹Ðº"],
  ]).resize();
}

function backKb(lang) {
  return Markup.keyboard([[TXT[lang].back]]).resize();
}

function getLang(ctx) {
  return userLang[ctx.from.id] || "ru";
}

function sendLanguagePicker(ctx) {
  return ctx.reply(
    TXT.ru.pickLang,
    Markup.keyboard([["ðŸ‡ºðŸ‡¦ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°", "ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹"]]).resize()
  );
}

function sendMainMenu(ctx) {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].welcome, menuKb(lang));
}

// ====== Commands ======
bot.command("id", (ctx) => ctx.reply(`Ð’Ð°Ñˆ chat_id: ${ctx.chat.id}`));
bot.start((ctx) => sendLanguagePicker(ctx));

bot.hears("ðŸ‡ºðŸ‡¦ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°", (ctx) => {
  userLang[ctx.from.id] = "ua";
  return sendMainMenu(ctx);
});

bot.hears("ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹", (ctx) => {
  userLang[ctx.from.id] = "ru";
  return sendMainMenu(ctx);
});

// ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ¼ÐµÐ½Ñ‹ ÑÐ·Ñ‹ÐºÐ° Ð¸Ð· Ð¼ÐµÐ½ÑŽ
bot.hears(/ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ·Ñ‹Ðº|Ð·Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ð¼Ð¾Ð²Ñƒ/i, (ctx) => {
  // ÑÐ·Ñ‹Ðº ÐÐ• ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ Ð²Ñ‹Ð±Ð¾Ñ€
  return sendLanguagePicker(ctx);
});

// ====== Menu actions ======
bot.hears(/ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸|Ð·Ð±Ñ–Ð»ÑŒÑˆÐ¸Ñ‚Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].growth, backKb(lang));
});

bot.hears(/Ð´ÐµÐ¼Ð¾ Ð·Ð° 60 ÑÐµÐºÑƒÐ½Ð´|Ð´ÐµÐ¼Ð¾-Ð·Ð°Ð¿Ð¸ÑÑŒ|Ð´ÐµÐ¼Ð¾-Ð·Ð°Ð¿Ð¸Ñ/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].demo, backKb(lang));
});

bot.hears(/Ñ€Ð°ÑÑ‡[ÐµÑ‘]Ñ‚ Ð¾ÐºÑƒÐ¿Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸|Ñ€Ð¾Ð·Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº Ð¾ÐºÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ–/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].roi, backKb(lang));
});

bot.hears(/Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°|Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].faq, backKb(lang));
});

bot.hears(/Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¾Ð¿Ð»Ð°Ñ‚Ð° \(Ð´ÐµÐ¼Ð¾\)/i, (ctx) => {
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].pay + PAYMENT_URL, backKb(lang));
});

// ====== Tariffs (new prices + scarcity + CTA) ======
bot.hears(/Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹|Ñ‚Ð°Ñ€Ð¸Ñ„Ð¸|ðŸ“Š Ñ‚Ð°Ñ€Ð¸Ñ„Ñ‹|ðŸ“Š Ñ‚Ð°Ñ€Ð¸Ñ„Ð¸/i, async (ctx) => {
  const lang = getLang(ctx);

  const text =
    lang === "ua"
      ? `ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ð¸ SalonFlow

ðŸ”¥ Ð¡Ð¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ð° Ñ†Ñ–Ð½Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÑˆÐ¸Ñ… 10 ÑÐ°Ð»Ð¾Ð½Ñ–Ð²
â³ Ð—Ð°Ð»Ð¸ÑˆÐ¸Ð»Ð¾ÑÑŒ Ð¼Ñ–ÑÑ†ÑŒ: ${SEATS_LEFT}

Starter â€” 1500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ
Pro â€” 2500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ
Salon â€” 4500 Ð³Ñ€Ð½/Ð¼Ñ–Ñ

Ð©Ð¾ Ð²Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ:

âœ” ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ñ–Ð´ ÐºÐ»ÑŽÑ‡
âœ” ÐžÐºÑ€ÐµÐ¼Ð° CRM-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´Ð»Ñ Ð²Ð°ÑˆÐ¾Ð³Ð¾ ÑÐ°Ð»Ð¾Ð½Ñƒ
âœ” ÐÐ²Ñ‚Ð¾Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ 24Ð³ / 2Ð³
âœ” ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°
âœ” ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð±ÐµÐ· Ð´Ð¾Ð¿Ð»Ð°Ñ‚

ðŸ‘‡ ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ñ‡Ðµ, Ñ‰Ð¾Ð± Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ CRM:`
      : `ðŸ’° Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹ SalonFlow

ðŸ”¥ Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ñ†ÐµÐ½Ð° Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ñ‹Ñ… 10 ÑÐ°Ð»Ð¾Ð½Ð¾Ð²
â³ ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¼ÐµÑÑ‚: ${SEATS_LEFT}

Starter â€” 1500 Ð³Ñ€Ð½/Ð¼ÐµÑ
Pro â€” 2500 Ð³Ñ€Ð½/Ð¼ÐµÑ
Salon â€” 4500 Ð³Ñ€Ð½/Ð¼ÐµÑ

Ð§Ñ‚Ð¾ Ð²Ñ…Ð¾Ð´Ð¸Ñ‚:

âœ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ð´ ÐºÐ»ÑŽÑ‡
âœ” ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ CRM-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ ÑÐ°Ð»Ð¾Ð½Ð°
âœ” ÐÐ²Ñ‚Ð¾Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ 24Ñ‡ / 2Ñ‡
âœ” ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
âœ” ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ð´Ð¾Ð¿Ð»Ð°Ñ‚

ðŸ‘‡ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ CRM:`;

  await ctx.reply(text, {
    reply_markup: {
      keyboard: [
        [
          {
            text: lang === "ua" ? "ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ CRM" : "ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ CRM",
          },
        ],
        [{ text: TXT[lang].back }],
      ],
      resize_keyboard: true,
    },
  });
});

// ====== Lead flow start ======
function startLead(ctx) {
  const uid = ctx.from.id;
  leadState[uid] = { step: 1, data: {} };
  const lang = getLang(ctx);
  return ctx.reply(TXT[lang].leadStart, Markup.removeKeyboard());
}

// Ð›Ð¾Ð²Ð¸Ð¼ RU/UA + ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸ (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹)
bot.hears(
  /Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ crm|Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ crm|Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÐ°Ð»Ð¾Ð½|Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ð¸ ÑÐ°Ð»Ð¾Ð½/i,
  startLead
);

// ====== Back (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ, ÐÐ• ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÑ‚ ÑÐ·Ñ‹Ðº) ======
bot.hears(/â¬…ï¸ Ð½Ð°Ð·Ð°Ð´|Ð½Ð°Ð·Ð°Ð´/i, (ctx) => {
  const uid = ctx.from.id;

  // ÐµÑÐ»Ð¸ Ð±Ñ‹Ð» Ð»Ð¸Ð´-Ñ„Ð»Ð¾Ñƒ â€” ÑÐ±Ñ€Ð¾ÑÐ¸Ð¼ ÐµÐ³Ð¾
  if (leadState[uid]) delete leadState[uid];

  return sendMainMenu(ctx);
});

// ====== Lead answers ======
bot.on("text", async (ctx) => {
  const uid = ctx.from.id;
  const st = leadState[uid];
  if (!st) return; // Ð½Ðµ Ð² Ð·Ð°ÑÐ²ÐºÐµ

  const lang = getLang(ctx);
  const text = String(ctx.message.text || "").trim();
  if (!text) return;

  if (st.step === 1) {
    st.data.city = text;
    st.step = 2;
    return ctx.reply(TXT[lang].q2);
  }

  if (st.step === 2) {
    st.data.masters = text;
    st.step = 3;
    return ctx.reply(TXT[lang].q3);
  }

  if (st.step === 3) {
    st.data.prepay = text;
    st.step = 4;
    return ctx.reply(TXT[lang].q4);
  }

  if (st.step === 4) {
    st.data.onlinePayBtn = text;

    const from = ctx.from;
    const adminMsg =
      "ðŸ§¾ ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° SalonFlow\n\n" +
      `ðŸ‘¤ ${from.first_name || ""} ${from.last_name || ""}\n` +
      `ðŸ†” user_id: ${from.id}\n` +
      (from.username ? `ðŸ”— @${from.username}\n` : "") +
      `ðŸ“ Ð“Ð¾Ñ€Ð¾Ð´: ${st.data.city}\n` +
      `ðŸ‘¥ ÐœÐ°ÑÑ‚ÐµÑ€Ð¾Ð²: ${st.data.masters}\n` +
      `ðŸ’° ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°: ${st.data.prepay}\n` +
      `ðŸ’³ ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹: ${st.data.onlinePayBtn}\n`;

    if (ADMIN_CHAT_ID) {
      await ctx.telegram.sendMessage(ADMIN_CHAT_ID, adminMsg);
    }

    delete leadState[uid];
    if (SEATS_LEFT > 0) SEATS_LEFT -= 1;

    await ctx.reply(TXT[lang].thanks);
    return sendMainMenu(ctx);
  }
});

bot.launch();
console.log("Sales bot started");
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));
